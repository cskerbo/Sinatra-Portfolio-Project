<link rel="stylesheet" type="text/css" href="/css/build.css">
<!--LINK JQUERY-->
<script type="text/javascript" src="/js/jquery-3.4.1.js"></script>
<script>
    // Create a global dictionary, mapping perk keys to perk descriptions
    // Each perk needs some kind of unique identifier -- could be a number you generate, or just the perk name
    var perkDescriptions = {
        "none": "Please select a perk from the list above",
    <%@perks.each do |p| %>
        "perk-option-<%=p.id %>": "<%=p.raw_html.gsub(/\R+/, ' ').gsub('"', '\\\\"') %>",
     <%end %>
    };

    // Handles selection changes in the four <select> lists
    function handlePerkChange(perkNumber) {
        // Get a reference to the <div> and <select> with ids perkX-description and perkX-select-list
        let targetDiv = document.getElementById("perk" + perkNumber + "-description");
        let targetSelect = document.getElementById("perk" + perkNumber + "-select-list");
        // Get the value of the currently selected option in the <select>
        let selectedValue = targetSelect.options[targetSelect.selectedIndex].value;
        // Get the description for the selected perk from our dictionary
        let perkDescription = perkDescriptions[selectedValue];
        // Set the target <div> contents to the value from our dictionary
        targetDiv.innerHTML = perkDescription;
    }

    // Function called once the browser has finished loading and parsing the HTML document
    // Running the same code inline (before the page is finished loading) would result in null references,
    // because JavaScript can't reference something the browser hasn't parsed from the document yet
    function initPage() {
        // Loop through each perk slot setting the description to the selected perk
        // Initially, this will just load the default "none" descriptions
        for (let index = 1; index <= 4; index++) {
            handlePerkChange(index);
        }
    }
</script>
<!--PERSONAL SCRIPT JavaScript-->
<body onload="initPage();">
<form name="build" onsubmit="return validatePerks() && validateForm();" action="/build/<%=@build.id %>" method="POST">
  <input type="hidden" name="_method"  id="hidden" value="patch">
  <div class="container">
    <div class="character-content">
      <div class="cs-how">
        <br>
        <h2>Enter a name for your build:</h2><br>
        <input type="text" name="build[name]" id="build-name" placeholder="ex. Stealth, Healing, Looping, My Favorite Build"><br>
        <h2>Select up to 4 perks.</h2><br>
        <p>Current perks selected:</p><br>
        <output>0 are checked<br><br><ul><li>No Values</li></ul></output><br>
        <button id="submit" type="submit">Save Build</button>
      </div>
      <div class="container-characters">
        <div class="fpbox" id="fpsurvivors" style="text-align: center;">
          <div class="heading"><a href="/Survivors" title="Survivors">Current Build</a>
          </div>
          <div class="fplinks" id="loadout">
            <div class="build">
              <%counter = 1 %>
            <% @build.perks.each do |p|%>
                <%edited_perk_name = p.name.gsub(/\s+/, "").gsub("'", "").gsub("-", "").gsub(":", "").gsub("&", "and").gsub("!", "")%>
                <%image_match = @image_list.select{|s| s.downcase.gsub("-", "").include?(edited_perk_name.downcase)}%>
                <%image_path_long = image_match * " "%>
                <%image_path_short = image_path_long.split('c/')[-1]%>
                <div class="loadout-display" id="perk-container">
                  <div id="perk<%counter %>-container" class="perk-container" onchange="handlePerkChange('<%=counter %>');">
                    <h4>Perk 1</h4>
                    <select id="perk<%=counter %>-select-list">
                      <option value="none">Select a perk</option>
                      <%@perks.each do |m| %>
                        <% if m.role == @build.build_type%>
                          <%if m.name == p.name %>
                          <option value="perk-option-<%=m.id %>" selected="selected"><%=m.name %></option>
                          <%else%>
                      <option value="perk-option-<%=m.id %>"><%=m.name %></option>
                            <%end %>
                          <%end %>
                        <%end %>
                    </select>
                    <div id="perk<%=counter %>-description" class="perk-description"></div>
                  </div>
                    <%counter += 1 %>

                </div>
                <br>

            <%end%>
            <%if @build.perks.count < 4 %>
                <%counter = @build.perks.count %>
                <% while counter < 4 %>
                <div class="loadout-display">
                  <div class="perk-top">
                    <div class="fplink plainlinks image">
                      <div class="box">
                        <div class="row">
                          <div class="cell">
                            <div class="image">
                              <a href="empty" title="empty"><img alt="Empty" src="/images/icon_perks.png"  width="190" height="210" /></a>
                            </div>
                            <div class="link">
                              <a href="empty" title="empty">Empty</a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="perk-selection" id="perk-selection-one">
                    <select id="optionList" name="build[perk_ids][]">
                      <option value="Select a Perk">Select a Perk</option>
                      <% @perks.each do |m|%>
                        <% if m.role == @build.build_type%>
                            <option class="unique" value="<%=m.id%>"><%=m.name%></option>
                        <%end%>
                      <%end%>
                    </select>
                    <% @perks.each do |m|%>
                      <% if m.role == @build.build_type%>
                        <div id="<%=m.id%> id" class="<%=m.id%> id" style="display:none;" value="<%=m.id%>"><%=m.description%></div>
                      <%end%>
                    <%end%>

                  </div>
                </div>
                  <% counter += 1 %>
                  <%end %>

              <%end %>

            </div>


          </div>
        </div>


        <!--<div class="fpbox" id="fpsurvivors" style="text-align: center;">
          <div class="heading"><a href="/Survivors" title="Survivors">Perk Selection</a>
          </div>

          <div class="fplinks">

            <% @perks.each do |p|%>
              <%if p.role == @build.build_type%>
                <%edited_perk_name = p.name.gsub(/\s+/, "").gsub("'", "").gsub("-", "").gsub(":", "").gsub("&", "and").gsub("!", "")%>
                <%image_match = @image_list.select{|s| s.downcase.gsub("-", "").include?(edited_perk_name.downcase)}%>
                <%image_path_long = image_match * " "%>
                <%image_path_short = image_path_long.split('c/')[-1]%>
                <div class="perk-selection">

                  <div class="perk-image">
                    <input class="single-checkbox" id="<%=p.name %>" type="checkbox" name="build[perk_ids][]" value="<%= p.id %>" <%='checked' if @build.perks.include?(p) %>>
                    <div class="fplink plainlinks image">
                      <div class="box">
                        <div class="row">

                          <div class="cell">

                            <div class="image">
                              <a href="/perks/<%= p.slug%>" title="<%= p.name %>"><img alt="<%= p.name %> Preview Portrait.png" src="/<%=image_path_short%>" width="190" height="210" /></a>
                            </div>
                            <div class="link">
                              <a href="/perks/<%= p.slug%>" title="<%= p.name %>"><%= p.name %></a>
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="perk-description">
                    <div class="perk-text"><%=p.description %></div>
                  </div>
                </div>
                <br>
              <%end%>
            <%end%>
          </div>
        </div>-->
      </div>
    </div>
  </div>
</form>
</body>